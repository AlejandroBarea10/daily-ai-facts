name: Daily Ephemeris Generation

on:
  schedule:
    # Ejecuta a las 01:00 CET (invierno) / CEST (verano) en España
    # CET = UTC+1 → 01:00 CET = 00:00 UTC
    # CEST = UTC+2 → 01:00 CEST = 23:00 UTC (día anterior)
    # GitHub Actions no maneja DST automáticamente, así que usamos dos cron:
    # - 00:00 UTC: octubre a marzo (CET) 
    # - 23:00 UTC (día anterior): marzo a octubre (CEST, + aprox. 3 semanas de transición)
    # Combinados cubren todo el año. La idempotencia en Supabase evita duplicados.
    - cron: '0 0 * * *'      # 00:00 UTC (01:00 CET en invierno)
    - cron: '0 23 * * *'     # 23:00 UTC (01:00 CEST en verano, mañana local)
  
  # Permite ejecutar manualmente desde GitHub Actions con input opcional target_date
  workflow_dispatch:
    inputs:
      target_date:
        description: 'Target date in YYYY-MM-DD format (e.g., 2026-01-14). If empty, uses tomorrow in Europe/Madrid.'
        required: false
        type: string

jobs:
  generate-ephemeris:
    runs-on: ubuntu-latest
    name: Generate Ephemeris

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Generate ephemeris
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TARGET_DATE: ${{ github.event.inputs.target_date || '' }}
        run: node scripts/generate-ephemeris.js

      - name: Log success
        if: success()
        run: echo "✅ Ephemeris generated successfully"

      - name: Log failure
        if: failure()
        run: echo "❌ Failed to generate ephemeris. Check logs above."
